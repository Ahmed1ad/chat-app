<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Chat</title>

<!-- Emoji Mart -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-mart@latest/css/emoji-mart.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:#0f172a;
  height:100vh;
  display:flex;
  justify-content:center;
}
.app{
  width:100%;
  max-width:480px;
  background:#f0f2f5;
  display:flex;
  flex-direction:column;
  height:100vh;
}

/* HEADER */
.header{
  background:#075e54;
  color:#fff;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header small{opacity:.8}

/* CHAT */
.chat{
  flex:1;
  padding:10px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.msg{
  max-width:75%;
  padding:8px 10px;
  border-radius:8px;
  font-size:15px;
  position:relative;
}
.me{align-self:flex-start;background:#dcf8c6}
.other{align-self:flex-end;background:#fff}
.msg .name{font-size:12px;opacity:.6}
.msg .meta{font-size:11px;opacity:.6;text-align:left}
.msg img,video,audio{max-width:100%;border-radius:6px}

/* FOOTER */
.footer{
  padding:6px;
  background:#f0f2f5;
}
.row{
  display:flex;
  gap:6px;
  align-items:center;
}
input[type=text]{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:1px solid #ccc;
}
button{
  border:none;
  border-radius:50%;
  width:42px;
  height:42px;
  cursor:pointer;
  font-size:18px;
}
.send{background:#00c853;color:#fff}
.attach{background:#ff9800;color:#fff}
.emoji{background:#03a9f4;color:#fff}
.voice{background:#9c27b0;color:#fff}

#emojiPicker{
  position:absolute;
  bottom:70px;
  display:none;
}
</style>
</head>

<body>

<div class="app">
  <div class="header">
    <div>
      <strong>Pro Chat</strong><br>
      <small id="status">Ù…ØªØµÙ„</small>
    </div>
    <button onclick="clearChat()" title="Ø­Ø°Ù Ø§Ù„Ø´Ø§Øª">ğŸ—‘ï¸</button>
  </div>

  <div class="chat" id="chat"></div>

  <div class="footer">
    <div class="row">
      <button class="emoji" onclick="toggleEmoji()">ğŸ˜€</button>
      <input id="msg" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
      <button class="attach" onclick="file.click()">ğŸ“</button>
      <button class="voice" id="voiceBtn">ğŸ™ï¸</button>
      <button class="send" onclick="sendText()">â¤</button>
    </div>
  </div>
</div>

<input type="file" id="file" hidden>

<div id="emojiPicker"></div>

<script src="/config.js"></script>

<script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  deleteDoc, doc, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* INIT */
const app = initializeApp(window.FIREBASE_CONFIG);
const db = getFirestore(app);

/* USER */
const uid = localStorage.uid ||= "u_"+Math.random().toString(36).slice(2);
const name = localStorage.username ||= prompt("Ø§Ø³Ù…Ùƒ");

/* CLOUDINARY */
const CLOUD_NAME="dfisng8rr";
const UPLOAD_PRESET="Chat-app";

/* EMOJI */
const picker = new EmojiMart.Picker({
  onEmojiSelect:e=>msg.value+=e.native
});
emojiPicker.appendChild(picker);

/* CHAT */
const chat = document.getElementById("chat");
const q = query(collection(db,"messages"),orderBy("time"));
onSnapshot(q,s=>{
  chat.innerHTML="";
  s.forEach(d=>{
    const m=d.data();
    const div=document.createElement("div");
    div.className="msg "+(m.uid===uid?"me":"other");
    let content=m.text||"";
    if(m.type==="image") content=`<img src="${m.url}">`;
    if(m.type==="video") content=`<video controls src="${m.url}"></video>`;
    if(m.type==="audio") content=`<audio controls src="${m.url}"></audio>`;
    div.innerHTML=`
      <div class="name">${m.name}</div>
      ${content}
      <div class="meta">
        <button onclick="del('${d.id}')">ğŸ—‘ï¸</button>
      </div>
    `;
    chat.appendChild(div);
  });
  chat.scrollTop=chat.scrollHeight;
});

/* SEND */
async function sendText(){
  if(!msg.value) return;
  await addDoc(collection(db,"messages"),{
    text:msg.value,uid,name,time:serverTimestamp()
  });
  msg.value="";
}

/* DELETE */
window.del=async(id)=>{
  if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")){
    await deleteDoc(doc(db,"messages",id));
  }
};
window.clearChat=async()=>{
  if(!confirm("Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø´Ø§ØªØŸ")) return;
  const snap=await getDocs(collection(db,"messages"));
  snap.forEach(d=>deleteDoc(d.ref));
};

/* FILE */
file.onchange=async()=>{
  if(!confirm("Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ")) return;
};

/* EMOJI */
window.toggleEmoji=()=>{
  emojiPicker.style.display =
    emojiPicker.style.display==="none"?"block":"none";
};

/* VOICE */
let recorder, recording=false;
voiceBtn.onclick=async()=>{
  if(!recording){
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    recorder=new MediaRecorder(stream);
    const chunks=[];
    recorder.ondataavailable=e=>chunks.push(e.data);
    recorder.onstop=async()=>{
      const blob=new Blob(chunks,{type:"audio/webm"});
      // upload here...
    };
    recorder.start();
    recording=true;
    voiceBtn.textContent="â¹ï¸";
  }else{
    recorder.stop();
    recording=false;
    voiceBtn.textContent="ğŸ™ï¸";
  }
};
</script>

</body>
</html>
