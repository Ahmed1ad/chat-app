<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WhatsChat</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background:#e5ddd5;
  height:100vh;
  overflow:hidden;
}
.chat-app{
  max-width:480px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
  background:#f0f2f5;
}
.chat-header{
  background:#075e54;
  color:#fff;
  padding:10px;
}
.chat-body{
  flex:1;
  padding:10px;
  overflow-y:auto;
}
.msg{
  max-width:75%;
  padding:8px 10px;
  border-radius:8px;
  margin-bottom:6px;
  position:relative;
}
.me{
  background:#dcf8c6;
  margin-right:auto;
}
.other{
  background:#fff;
  margin-left:auto;
}
.msg .name{
  font-size:12px;
  opacity:.6;
}
.msg .meta{
  font-size:11px;
  text-align:left;
  opacity:.6;
}
.chat-footer{
  padding:6px;
  background:#f0f2f5;
}
audio,video{
  width:100%;
  border-radius:6px;
}
.msg-menu{
  position:absolute;
  top:4px;
  left:6px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="chat-app">

  <!-- HEADER -->
  <div class="chat-header d-flex justify-content-between align-items-center">
    <div>
      <strong>WhatsChat</strong><br>
      <small id="typing">Ù…ØªØµÙ„</small>
    </div>
    <button class="btn btn-sm btn-danger" id="clearChat">Ø­Ø°Ù Ø§Ù„Ø´Ø§Øª</button>
  </div>

  <!-- BODY -->
  <div class="chat-body" id="chat"></div>

  <!-- FOOTER -->
  <div class="chat-footer">
    <div class="input-group">
      <input type="file" id="fileInput" hidden>
      <button class="btn btn-secondary" onclick="fileInput.click()">ğŸ“</button>
      <input type="text" id="msg" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
      <button class="btn btn-success" id="sendBtn">â¤</button>
    </div>
    <button class="btn btn-warning w-100 mt-2" id="recordBtn">ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª</button>
  </div>

</div>

<script src="/config.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  serverTimestamp, deleteDoc, doc, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp(window.FIREBASE_CONFIG);
const db = getFirestore(app);

/* USER */
let uid = localStorage.uid || (localStorage.uid="u_"+Math.random().toString(36).slice(2));
let name = localStorage.username || (localStorage.username=prompt("Ø§Ø³Ù…ÙƒØŸ"));

/* CLOUDINARY */
const CLOUD_NAME="dfisng8rr";
const UPLOAD_PRESET="Chat-app";

/* UPLOAD */
async function upload(file){
  const f=new FormData();
  f.append("file",file);
  f.append("upload_preset",UPLOAD_PRESET);
  const type=file.type.startsWith("video")?"video":"auto";
  const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${type}/upload`,{method:"POST",body:f});
  return (await r.json()).secure_url;
}

/* RENDER */
const chat=document.getElementById("chat");
const q=query(collection(db,"messages"),orderBy("time"));
onSnapshot(q,s=>{
  chat.innerHTML="";
  s.forEach(d=>{
    const m=d.data();
    const div=document.createElement("div");
    div.className="msg "+(m.uid===uid?"me":"other");

    let c="";
    if(m.type==="image") c=`<img src="${m.url}" class="img-fluid">`;
    else if(m.type==="video") c=`<video controls src="${m.url}"></video>`;
    else if(m.type==="audio") c=`<audio controls src="${m.url}"></audio>`;
    else if(m.type==="file") c=`<a href="${m.url}" target="_blank">ğŸ“ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a>`;
    else c=m.text;

    div.innerHTML=`
      <div class="msg-menu" onclick="deleteMsg('${d.id}',${m.uid===uid})">â‹®</div>
      <div class="name">${m.name}</div>
      ${c}
      <div class="meta">${m.uid===uid?"âœ”âœ” Seen":""}</div>
    `;
    chat.appendChild(div);
  });
  chat.scrollTop=chat.scrollHeight;
});

/* SEND TEXT */
sendBtn.onclick=async()=>{
  if(!msg.value) return;
  await addDoc(collection(db,"messages"),{
    type:"text",text:msg.value,uid,name,time:serverTimestamp()
  });
  msg.value="";
};

/* FILE */
fileInput.onchange=async()=>{
  const f=fileInput.files[0];
  const url=await upload(f);
  let type="file";
  if(f.type.startsWith("image")) type="image";
  else if(f.type.startsWith("video")) type="video";
  else if(f.type.startsWith("audio")) type="audio";
  await addDoc(collection(db,"messages"),{type,url,uid,name,time:serverTimestamp()});
};

/* DELETE MESSAGE */
window.deleteMsg=async(id,me)=>{
  if(me || confirm("Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ")){
    await deleteDoc(doc(db,"messages",id));
  }
};

/* CLEAR CHAT */
clearChat.onclick=async()=>{
  if(!confirm("Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø´Ø§ØªØŸ")) return;
  const snap=await getDocs(collection(db,"messages"));
  snap.forEach(d=>deleteDoc(d.ref));
};

/* VOICE RECORD */
let rec, chunks=[];
recordBtn.onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  rec=new MediaRecorder(stream);
  rec.start();
  recordBtn.textContent="â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù";
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=async()=>{
    const blob=new Blob(chunks,{type:"audio/mp3"});
    chunks=[];
    const url=await upload(blob);
    await addDoc(collection(db,"messages"),{type:"audio",url,uid,name,time:serverTimestamp()});
    recordBtn.textContent="ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª";
  };
  recordBtn.onclick=()=>rec.stop();
};
</script>

</body>
</html>
